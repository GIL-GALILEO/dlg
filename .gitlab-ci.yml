stages:
  - setup_db_solr
  - setup_web_and_test
  - deconstruct


setup_db_solr:
  stage: setup_db_solr
  script:
  - docker network rm dlg_testing
  - docker network create dlg_testing
  - docker run -d --name solr --expose 8983 -v `pwd`:/data -w /data --network dlg_testing --network-alias=solr --entrypoint "/bin/bash" solr:6 /data/provision/solr-entrypoint.sh
  - curl -X POST 'http://solr:8983/solr/meta-test/update/json?commit=true' --data-binary @provision/data.json -H 'Content-type:application/json'
  - docker run --name db --expose 5432 --network dlg_testing --network-alias=db -d postgres
  - docker ps
  tags: 
    - shell
    
setup_web_and_test:
  stage: setup_web_and_test
  script:
  - docker run -d --name web -v `pwd`:/code -w /code --network dlg_testing --network-alias=web --entrypoint "/bin/bash" ruby:2.4.5 /code/provision/web-entrypoint.sh && docker attach web
  tags:
    - shell

deconstruct:
  stage: deconstruct
  script:
  - docker rm -f solr db web && docker network rm dlg_testing
  when: always
  tags:
   - shell
